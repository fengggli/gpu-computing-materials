/*
 * Description:
 *
 * Author: Feng Li
 * e-mail: fengggli@yahoo.com
 */

#include <awnn/layer_pool.h>
#include "test_util.h"
#include "awnn/layer_conv.h"
#include "awnn/tensor.h"

#include "gtest/gtest.h"

namespace {

// The fixture for testing class Foo.
  class LayerConvTestDevice : public ::testing::Test {
  protected:
    // You can remove any or all of the following functions if its body
    // is empty.

    LayerConvTestDevice() {
      // You can do set-up work for each test here.
    }

    ~LayerConvTestDevice() override {
      // You can do clean-up work that doesn't throw exceptions here.
    }

    // If the constructor and destructor are not enough for setting up
    // and cleaning up each test, you can define the following methods:

    void SetUp() override {
      // Code here will be called immediately after the constructor (right
      // before each test).
    }

    void TearDown() override {
      // Code here will be called immediately after each test (right
      // before the destructor).
    }
  };


#ifdef USE_CUDA
  TEST_F(LayerConvTestDevice, BackwardDevice) {
    uint const shape_x[] = {6, 2, 7, 7};  // 6 images, 2x7x7
    uint const shape_y[] = {6, 2, 1, 1};

    tensor_t x = tensor_make_linspace(0.1, 0.3, shape_x, dim_of_shape(shape_x));
    tensor_t y = tensor_make(shape_y, dim_of_shape(shape_y));

    status_t ret;
    lcache_t cache;
    make_empty_lcache(&cache);

    ret = global_avg_pool_forward_device(x, &cache, y);  // foward function should allocate and populate cache;
    EXPECT_EQ(ret, S_OK);

    // check forward value
    tensor_t y_ref = tensor_make_alike(y);
    T value_list[] = {0.10817717, 0.12487223, 0.14156729, 0.15826235,
                      0.17495741, 0.19165247, 0.20834753, 0.22504259,
                      0.24173765, 0.25843271, 0.27512777, 0.29182283};
    tensor_fill_list(y_ref, value_list, dim_of_shape(value_list));
    EXPECT_LT(tensor_rel_error(y_ref, y), 1e-7);

    // input for backward
    tensor_t dy = tensor_make_linspace(-0.1, 0.5, shape_y,
                                       dim_of_shape(shape_y));  // some fake data

    // output for backward
    tensor_t dx = tensor_make_alike(x);

    ret = global_avg_pool_backward_device(dx, &cache, dy);  // backward needs to call lcache_free_all(cache);
    EXPECT_EQ(ret, S_OK);

    /* II. Numerical check */
    // variable
    tensor_t dx_ref = tensor_make_alike(x);

    // evaluate gradient of x
    eval_numerical_gradient(
      [](tensor_t const in, tensor_t out) {
        global_avg_pool_forward(in, NULL, out);
      },
      x, dy, dx_ref);
    EXPECT_LT(tensor_rel_error(dx_ref, dx), 1e-7);
    PINF("gradient check of x... is ok");
  }

  TEST_F(LayerConvTestDevice, tensor_make_transpose_3012_device) {
    uint shape_a[] = { 4, 3, 5, 5 };
    T a_vals[] = { 0.41794341085522313, 1.3971002787857785, -1.7859043087115503, -0.7088277337845966, -0.0747253160682306, -0.7750167689275921, -0.1497979028339611, 1.861729024181691, -1.4255292997340048, -0.37635669945558553, -0.34227539040889354, 0.2949076365884559, -0.8373237303359339, 0.9521876694706098, 1.3293165911581368, 0.5246524534266106, -0.14809998485203169, 0.8895319487581098, 0.12444652777226958, 0.9910925119539081, 0.03514666175300746, 0.2620708288499113, 0.14320172528233172, 0.9010171565792489, 0.23185862873793547, -0.7972579273763638, 0.12001013863647965, -0.6567960792631642, 0.2691745562241789, 0.33366699997653043, 0.27423502702150837, 0.7621571732385133, -0.6955005820433309, 0.29214712273333954, -0.3848994243313884, 0.12287470486756306, -1.429044965213544, 0.7028628331105681, -0.8585094698626066, -1.1404297940341468, -1.5853599691899731, -0.015301379345692975, -0.3215608325334026, 0.5683493580033092, -0.1996172239498275, 1.2728662476311292, 1.2729253412270798, 1.5810296827287635, -1.7562671506546559, 0.92177430325738, -0.6753053991328329, -1.4344361619118935, 0.47021124900258615, 0.03196734481675061, 0.044485739868283886, 0.478248788465422, -2.5133518072246144, -1.1574024538061867, -0.7047041260562744, -1.049788786843772, -1.9079558852768994, 0.4925876466762824, 0.8373616558728346, -1.4288134019022682, -0.18982427090586898, -1.1409494297894542, -2.125707548281193, -0.41354791391010853, 0.44148974929029244, 0.1641111275970974, -0.655050654305366, -0.3021276504874031, -0.2570446556118492, -0.12841367512708962, 0.26338592586586757, 0.1672180976389835, -0.3087195082120255, -1.2675446165023854, -0.22319021858209964, -0.8299343317402131, -1.1127182643859093, -0.4461309491361325, -0.40001719145095466, 0.36343905062372345, 0.9499277727984982, -0.3237944715119395, 0.2703170443447182, -0.6338114802668768, -2.71484267999538, 0.655761388450809, -1.1700485803166998, 0.05986850445781433, -1.6418272862287349, -0.280696341996669, -0.679469722093652, -1.8048009425587035, 0.5377056445228056, -0.12171368732909327, -1.0425094854013532, 0.1382879240053377, -0.22557183073305853, -1.1928828974770058, -0.6832069571234363, 0.19909408363714595, 0.03070660851095254, -0.4497263918219797, 0.14447531792933055, -0.3522959424307149, 0.4882136044332558, -0.4347098980295436, -0.2869226545671573, -0.8433809712713103, -0.10827394157014732, 0.8543475733897531, -0.9037733806582785, -1.0525583975222925, -0.3040979377506749, 0.1808372568789206, -0.4125416965513796, 1.2291394847717072, -0.9779174798249857, -0.6397852443847831, -0.008809632306708488, 0.3621329398278571, 0.3514816184270762, -1.2006403517076578, -0.8427296246761574, 1.6183250145045431, -2.3907947820609508, 0.8825621182260758, -1.120820079094235, 0.12416778336846195, -2.4343459839991644, -1.627017037627793, -1.10613945219778, 2.0086233662587105, 0.9144799162396965, -0.8694385622461366, 0.13741017094622798, -0.7226146471732044, -0.675551804679947, -0.04084145086621429, -1.1575589386869476, -0.674981239441945, 0.4425264360670702, -0.11970425059950714, 0.5970058589921657, -2.0399062997469763, -0.6447032952972855, -1.6170034620525995, -1.8557078450087228, 0.7480523973616027, 1.9700946071367569, -0.8196719116163029, 0.4236752100704024, -1.8357069782628097, 1.0058362728839167, 0.058344972975191776, 0.9868701899116253, 0.2782751258796722, 0.11961900053654728, 2.139351491242037, -0.7742989087922805, -0.42011785184253997, -0.7776831591077382, -1.014158604910159, -2.3029611560826266, -0.36784550095233615, 0.5919036732177574, -0.5601635730810177, 1.0333967558810244, -1.2071857470165404, -0.9342658886342725, 0.9223483689072072, 0.37364742976269966, -0.2605138805775921, 0.6125076456009582, -0.6264779075442526, -0.4029807295170146, 0.08972094526218036, -0.5879939611796147, -0.5750856367708188, 0.5787864078006713, -1.7450688216823005, -0.2476718017571967, 0.7330962871742813, 1.0973434816476881, 0.1554258669795301, -0.37233773054399544, -0.32986356748392365, -0.04243927686679934, -0.0039677801794608305, 0.20182891139246234, -0.6627804231941763, 0.15851809186292745, -1.632601889445862, -0.9308637017986084, -0.6309686706363575, -1.886978847883294, -1.1058166965559622, 0.6024041253149112, -0.7264984715903179, -1.161598947687029, 2.4629559137789943, 1.4210361216913123, -0.9994552404623392, -0.17333223180350746, -0.368762922932822, 0.9123253128937537, 0.9541408834407947, 0.9814422079325648, -0.16850276288388696, -1.422374775872722, -0.08069124722574583, 0.3172668420685232, -0.5290065147376088, 0.7147361162865893, -0.31626845774098866, 0.08296378600028348, 0.7492436133012159, 0.843882149107926, -0.42419808422692024, -0.12423676801085984, -1.8175545421909924, 0.028925097003605134, -0.38761310746695077, 1.3582022615738831, -1.3224040751078836, 1.8968843349801061, -1.2715906265432333, -1.218556367021417, 0.41306749534437354, -0.14805046785377862, -0.6602617822535048, 0.6136317966398424, 1.1070523291050671, -3.1055763948489052, -0.5915648390097887, 0.486356288768445, 0.4182332513440316, -0.11310805746770072, 0.1590371561859675, -1.6329004747104092, -0.11545225206591017, 0.3901944521782853, 0.426109512171444, 0.22602016515008233, -0.04113994247198553, 0.38171273340231, 0.2716345948371162, -0.23639883305863021, 1.0014609572365405, -2.2713292064513095, 1.5641965632818045, -0.03793764735954767, -0.6145326108542524, 1.2126286957418586, -0.519096694509948, 1.9219015003026336, 1.5659692575287734, 0.267644209747774, 1.8444185728556877, -0.13559209216818383, 0.8854428524955673, 1.3436943073937089, 0.785459585974516, 0.5200326723492461, -0.478305739294987, -0.20406350725469713, -0.9555649058996949, -1.6896114168600198, 0.37475897164069283, 0.8202295043735098, -1.8500797640893578, 0.8241872188971253, -1.2895610326384992, -1.5031450462392673, -1.3600255868721276, 1.3474125378843316, 0.7343034160870375, -1.6613541482833338, 1.0756414909002867, 1.2559336916935622, 2.925604818520444, 1.0390458216800371, 0.3863370812432974, -0.29078883281053536, 2.276388266524854, 0.9643976605343368, -1.3202737847177353, -0.5521276082207549, 0.9934695389346138, 0.194313666716798, 1.602007851156059, -1.4710793115364962, -0.7780530670263663, 2.5369594154715855, 1.0865538378896509, -0.17462456877825375, -0.03606740078639175 };
    tensor_t a = tensor_make(shape_a, dim_of_shape(shape_a));
    tensor_fill_list(a, a_vals, array_size(a_vals));

    uint shape_b[] = { 2, 3, 3, 3 };
    T b_vals[] = { 0.19221725507708703, -0.3125829755887099, 0.7055124223647004, -1.5114176241804191, -0.7863321637261452, 0.06254840416735859, -0.6111954499450867, -0.11340763541289833, 0.6709245043083163, 0.8948141052497653, -0.012116509365354827, 0.9412431474917984, 0.42741187106100825, -1.705882183351619, 1.240924243746245, -1.058979904772874, 0.04659436029885103, -0.1998136446527477, 0.2930203744553751, 0.11813175390112939, 1.3920874377240013, -1.1528215977553828, 1.9380358462581537, -0.8759024989399083, -1.2406776470459164, -1.7575451615583342, 0.29674551314885234, -0.34874436508108597, -0.08407672060256344, -0.7209300883579461, -0.4610682468069884, 1.4149439612380326, -0.1218500237084761, -0.7737548980638933, 0.29083102774277114, -0.3590607358577159, -1.2286097483058647, -0.16314373361715404, -0.6646283932930266, 2.677253560986361, 0.5187415651747499, 0.78721801573021, 0.9690931171400049, 0.19702704947477864, -0.12912315402903862, -0.6153430344777464, 0.07662235729972101, -0.47899395916776244, -0.7602572357092611, 1.0820280860858755, -0.10603494414178737, -1.3486881648075113, -0.89680626571304, 1.3473101402250076 };
    tensor_t b = tensor_make(shape_b, dim_of_shape(shape_b));
    tensor_fill_list(b, b_vals, array_size(b_vals));

    tensor_t transpose_a_3102_ref = tensor_make_transpose_3012(a);
    tensor_t transpose_b_3102_ref = tensor_make_transpose_3012(b);

    tensor_t transpose_a_3102_dev = tensor_make_transpose_3012_device(a);
    tensor_t transpose_b_3102_dev = tensor_make_transpose_3012_device(b);

    EXPECT_LT(tensor_rel_error(transpose_a_3102_dev, transpose_a_3102_ref), 1e-7);
    EXPECT_LT(tensor_rel_error(transpose_b_3102_dev, transpose_b_3102_ref), 1e-7);
  }

  TEST_F(LayerConvTestDevice, device_padding_1) {
    uint padding = 2;
    T pad_val = 0;

    uint shape_x [] = { 4, 3, 5, 5 };
    T x_vals[] = { -1.1124192987279753, -0.2987021326731024, -1.5717747799328543, 0.46767852410704136, -0.5028396636863578, 1.2617791569008552, -0.8585177727135882, -0.4600186852958477, -0.8077329473172338, 0.837235386721364, 0.7478347190253026, 0.5850240381114719, -0.6831412335120908, 0.058290015100482956, -0.20611346086035787, -0.0092610242642353, -0.44755780283533303, -0.253571347515263, 0.42442240380494484, 2.6112401994576913, 0.04861055692381238, -1.334453282928918, 0.7635961060571415, 1.5514060401392846, -1.3052188197958443, 1.3260095486113894, 0.8431812466250782, 1.3676397314745337, 0.4531808049657844, -0.26291312137449074, -0.7211846215031593, -0.41416476352211357, -0.7680383160486547, -1.5318621825008, -0.3578911332878774, 0.7759619266407034, -1.3431405218925165, -1.0063651740163926, -1.6542786299577552, -0.0546864101929225, 0.2110140307646673, -0.3768080385512793, -1.236797331853251, -0.1610635551341412, 1.0174638581542046, -1.7367701044281203, -1.2283226039281405, 1.544560063887768, -0.4577045674271423, -0.7267430108380676, -0.07147860413052132, 0.9483790393812896, 1.7129304374092102, 0.9467885337972222, -0.3541119869095083, 0.22755764922282137, 0.12163258604731675, 0.25732471941926455, 0.9886240504478493, 0.5601018574871774, -0.20450779339165723, -1.7077708511855116, -0.13013898639586138, 0.6079635545151538, 1.8886464208154448, -0.33226820215451974, -0.9686175941627132, 0.5649245499892915, -0.0044642904064593775, 0.03760473819194514, 0.7337002457763613, -1.7729387255390459, -0.046409256477280704, 0.6425112000074827, -0.4977857367683314, 0.7268829359507735, 1.0032165104227362, -0.6284984811880521, 0.17805656968486314, -0.014731135292292868, 0.9789927509821577, 0.09451447627885204, 0.17697028851028174, 1.0380679709985514, 1.0817780228586553, -0.8107008934371845, -0.6611898202651927, 0.4854310252420187, -0.21749810423696767, -0.7466953665614954, 0.17713389150383874, 0.19543354416360004, -0.04159744786730165, -0.3725044238710123, 0.7512088232874237, -0.771522407358809, 2.871219166464713, 0.2039736982769261, -0.17997388139156587, -0.6399549163641237, 0.7744330855318006, 2.25374450995983, -0.05617520123964064, 0.12081210772680644, 0.5345709706713304, -0.47548711865517834, -0.3066794980448487, -0.490663268698044, -1.0371380166676183, 0.7703229854920346, 0.3549900601179667, 1.6750252258682228, 2.1486748072483266, -0.9901275968971489, 0.608855344955566, -1.5302605972311867, 0.4656299607725897, -0.3551038820768038, -1.7065095073639251, -0.44279072724275603, -1.4717675757154216, 1.4748663019358406, 0.9354144556556001, 1.5333288764673847, -0.24395397881950812, 0.5796240826007605, -0.49618555357037075, 0.28379815216041704, -0.19429534593894787, -1.1281402889689527, 0.05140785554047687, 1.109003797791513, 0.10897572029369339, -0.7731322746786203, -0.07224906455636274, 1.5280643397671534, -0.5278848662905093, -0.47969299309344654, 1.718203478445837, 0.7373979390810084, 0.706670378804652, 0.39614034997439396, 0.49113458230443224, 1.6696855126170689, -1.2172522862953776, 0.20952491935114692, 0.04892714984661481, -1.9160747516922991, 0.7386962124836524, 0.14513097807367578, -0.41165110075172595, 0.4263195154168612, 1.059784992138269, 1.4396088218871332, 0.7875697623914744, 0.9197300938205939, -1.4838378616119423, 1.4025716495181753, -0.05742995650586157, -0.6628883583766395, -0.5540344135180969, -0.44655016139385023, -0.006333515734975038, -2.1399813677412287, -0.6623518265981271, 0.9939613809909453, -0.19740203989060595, 0.9321441807936072, 0.9608146403642486, -0.4351589019257472, 0.26220373811543335, -0.5710795497721404, 1.2082795439533207, -0.7496169866130366, -0.4360683763118623, -1.6415267042581436, 1.939907299240552, 0.9076772658657487, -0.00972516168486708, 0.10147601683170539, 0.06479463395816823, 0.8107139765683411, -0.5172929107224695, -1.0472327968440898, -1.3892994115182793, 0.8954615029175255, -0.8466045907148847, 0.6154824642536586, 0.7268584652936476, 1.838996443956697, -0.5847908764407355, -1.1011287947744466, 0.8010453177345396, 0.7501909639555887, 0.5501036795757065, 1.90942382787931, 0.30164664998042606, 0.8035841580641391, 1.0578983671386755, -0.5241724372612193, -0.9641123880248004, -0.22242605845205113, 0.13584339545444318, -1.6399978950667582, 1.1009293945087857, -0.4686778600191537, 0.962060577195541, -0.9899977318189975, 0.40140183035834603, -0.3808754358690001, -1.5376576761246183, -0.1113750451591103, -0.05433153669770133, 0.04270756686038058, 0.11016307773333747, 0.7088226143339001, 0.6623964615006589, -1.6437880492686265, 0.24972227567866892, -0.7190909576687361, 0.8709221416922429, 0.9736833351032012, -1.4354208104612605, -0.21452624995931732, -0.24002341761145385, -0.8792799209819383, -0.20515069357230428, -0.9031053506541381, 0.30535699100144026, -1.3242346085838523, -0.2829852663605533, 0.6683862897277222, 1.5413221726616706, 0.015682502128203546, 1.8958955433429994, -1.8359568427505848, -0.6421019796721616, -0.6269020512767177, 0.7983102935697899, 0.3213097538334444, -0.01729979144420373, -0.4665185278843038, -0.7404381133770168, -0.09081710503328452, 0.9717611879428086, -0.15150361419287176, -1.3777300045321985, -0.6882762365654653, 1.1808382500511247, 0.2947398967718114, -0.7422804999805976, -1.6899175730753098, 0.20521305566233092, 0.1309470591384737, 1.6389823367575194, -0.22289002202115676, -0.07079897911318238, 0.4555888580331955, -0.9774805568535512, -0.07492800931526063, 0.2526615479800317, -0.1516626294547181, -1.0464629686670555, -0.5911144096314415, 0.9348812133375618, -0.27214147574211345, -0.3348828926273507, 2.397998460935664, 0.12247872552936973, 0.9434489339504347, -0.6209545562450115, 0.8905317474804172, 1.2224440041810367, 1.4018536953423328, -0.6227804114970024, -1.3753419699769953, -0.4501284244570541, 0.1167711030619468, 0.244337560269405, 0.3227534725786205, -0.232650848389198, 0.5739554204930342, 0.25375005710835125, -0.23803764584562334, -1.993692474771535, -1.351782241279723, -1.6920626261921234, -1.2293336526286616, 0.9668537008565808, 0.0007723360430257239, -0.01230656738724467, 0.2675760840548762, 1.2762595664679257, 0.4102269624410474, -0.3722302434381652, 1.3372499867379761, -0.5879746009834493, -1.2257918141748945, -2.099874162209954, -0.20144638655894623 };
    tensor_t x = tensor_make(shape_x, dim_of_shape(shape_x));
    tensor_fill_list(x, x_vals, array_size(x_vals));

    uint shape_padded[] = { 4, 3, 9, 9 };
    T ref_vals[] = { 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.1124192987279753, -0.2987021326731024, -1.5717747799328543, 0.46767852410704136, -0.5028396636863578, 0.0, 0.0, 0.0, 0.0, 1.2617791569008552, -0.8585177727135882, -0.4600186852958477, -0.8077329473172338, 0.837235386721364, 0.0, 0.0, 0.0, 0.0, 0.7478347190253026, 0.5850240381114719, -0.6831412335120908, 0.058290015100482956, -0.20611346086035787, 0.0, 0.0, 0.0, 0.0, -0.0092610242642353, -0.44755780283533303, -0.253571347515263, 0.42442240380494484, 2.6112401994576913, 0.0, 0.0, 0.0, 0.0, 0.04861055692381238, -1.334453282928918, 0.7635961060571415, 1.5514060401392846, -1.3052188197958443, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.3260095486113894, 0.8431812466250782, 1.3676397314745337, 0.4531808049657844, -0.26291312137449074, 0.0, 0.0, 0.0, 0.0, -0.7211846215031593, -0.41416476352211357, -0.7680383160486547, -1.5318621825008, -0.3578911332878774, 0.0, 0.0, 0.0, 0.0, 0.7759619266407034, -1.3431405218925165, -1.0063651740163926, -1.6542786299577552, -0.0546864101929225, 0.0, 0.0, 0.0, 0.0, 0.2110140307646673, -0.3768080385512793, -1.236797331853251, -0.1610635551341412, 1.0174638581542046, 0.0, 0.0, 0.0, 0.0, -1.7367701044281203, -1.2283226039281405, 1.544560063887768, -0.4577045674271423, -0.7267430108380676, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.07147860413052132, 0.9483790393812896, 1.7129304374092102, 0.9467885337972222, -0.3541119869095083, 0.0, 0.0, 0.0, 0.0, 0.22755764922282137, 0.12163258604731675, 0.25732471941926455, 0.9886240504478493, 0.5601018574871774, 0.0, 0.0, 0.0, 0.0, -0.20450779339165723, -1.7077708511855116, -0.13013898639586138, 0.6079635545151538, 1.8886464208154448, 0.0, 0.0, 0.0, 0.0, -0.33226820215451974, -0.9686175941627132, 0.5649245499892915, -0.0044642904064593775, 0.03760473819194514, 0.0, 0.0, 0.0, 0.0, 0.7337002457763613, -1.7729387255390459, -0.046409256477280704, 0.6425112000074827, -0.4977857367683314, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7268829359507735, 1.0032165104227362, -0.6284984811880521, 0.17805656968486314, -0.014731135292292868, 0.0, 0.0, 0.0, 0.0, 0.9789927509821577, 0.09451447627885204, 0.17697028851028174, 1.0380679709985514, 1.0817780228586553, 0.0, 0.0, 0.0, 0.0, -0.8107008934371845, -0.6611898202651927, 0.4854310252420187, -0.21749810423696767, -0.7466953665614954, 0.0, 0.0, 0.0, 0.0, 0.17713389150383874, 0.19543354416360004, -0.04159744786730165, -0.3725044238710123, 0.7512088232874237, 0.0, 0.0, 0.0, 0.0, -0.771522407358809, 2.871219166464713, 0.2039736982769261, -0.17997388139156587, -0.6399549163641237, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7744330855318006, 2.25374450995983, -0.05617520123964064, 0.12081210772680644, 0.5345709706713304, 0.0, 0.0, 0.0, 0.0, -0.47548711865517834, -0.3066794980448487, -0.490663268698044, -1.0371380166676183, 0.7703229854920346, 0.0, 0.0, 0.0, 0.0, 0.3549900601179667, 1.6750252258682228, 2.1486748072483266, -0.9901275968971489, 0.608855344955566, 0.0, 0.0, 0.0, 0.0, -1.5302605972311867, 0.4656299607725897, -0.3551038820768038, -1.7065095073639251, -0.44279072724275603, 0.0, 0.0, 0.0, 0.0, -1.4717675757154216, 1.4748663019358406, 0.9354144556556001, 1.5333288764673847, -0.24395397881950812, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5796240826007605, -0.49618555357037075, 0.28379815216041704, -0.19429534593894787, -1.1281402889689527, 0.0, 0.0, 0.0, 0.0, 0.05140785554047687, 1.109003797791513, 0.10897572029369339, -0.7731322746786203, -0.07224906455636274, 0.0, 0.0, 0.0, 0.0, 1.5280643397671534, -0.5278848662905093, -0.47969299309344654, 1.718203478445837, 0.7373979390810084, 0.0, 0.0, 0.0, 0.0, 0.706670378804652, 0.39614034997439396, 0.49113458230443224, 1.6696855126170689, -1.2172522862953776, 0.0, 0.0, 0.0, 0.0, 0.20952491935114692, 0.04892714984661481, -1.9160747516922991, 0.7386962124836524, 0.14513097807367578, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.41165110075172595, 0.4263195154168612, 1.059784992138269, 1.4396088218871332, 0.7875697623914744, 0.0, 0.0, 0.0, 0.0, 0.9197300938205939, -1.4838378616119423, 1.4025716495181753, -0.05742995650586157, -0.6628883583766395, 0.0, 0.0, 0.0, 0.0, -0.5540344135180969, -0.44655016139385023, -0.006333515734975038, -2.1399813677412287, -0.6623518265981271, 0.0, 0.0, 0.0, 0.0, 0.9939613809909453, -0.19740203989060595, 0.9321441807936072, 0.9608146403642486, -0.4351589019257472, 0.0, 0.0, 0.0, 0.0, 0.26220373811543335, -0.5710795497721404, 1.2082795439533207, -0.7496169866130366, -0.4360683763118623, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.6415267042581436, 1.939907299240552, 0.9076772658657487, -0.00972516168486708, 0.10147601683170539, 0.0, 0.0, 0.0, 0.0, 0.06479463395816823, 0.8107139765683411, -0.5172929107224695, -1.0472327968440898, -1.3892994115182793, 0.0, 0.0, 0.0, 0.0, 0.8954615029175255, -0.8466045907148847, 0.6154824642536586, 0.7268584652936476, 1.838996443956697, 0.0, 0.0, 0.0, 0.0, -0.5847908764407355, -1.1011287947744466, 0.8010453177345396, 0.7501909639555887, 0.5501036795757065, 0.0, 0.0, 0.0, 0.0, 1.90942382787931, 0.30164664998042606, 0.8035841580641391, 1.0578983671386755, -0.5241724372612193, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.9641123880248004, -0.22242605845205113, 0.13584339545444318, -1.6399978950667582, 1.1009293945087857, 0.0, 0.0, 0.0, 0.0, -0.4686778600191537, 0.962060577195541, -0.9899977318189975, 0.40140183035834603, -0.3808754358690001, 0.0, 0.0, 0.0, 0.0, -1.5376576761246183, -0.1113750451591103, -0.05433153669770133, 0.04270756686038058, 0.11016307773333747, 0.0, 0.0, 0.0, 0.0, 0.7088226143339001, 0.6623964615006589, -1.6437880492686265, 0.24972227567866892, -0.7190909576687361, 0.0, 0.0, 0.0, 0.0, 0.8709221416922429, 0.9736833351032012, -1.4354208104612605, -0.21452624995931732, -0.24002341761145385, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.8792799209819383, -0.20515069357230428, -0.9031053506541381, 0.30535699100144026, -1.3242346085838523, 0.0, 0.0, 0.0, 0.0, -0.2829852663605533, 0.6683862897277222, 1.5413221726616706, 0.015682502128203546, 1.8958955433429994, 0.0, 0.0, 0.0, 0.0, -1.8359568427505848, -0.6421019796721616, -0.6269020512767177, 0.7983102935697899, 0.3213097538334444, 0.0, 0.0, 0.0, 0.0, -0.01729979144420373, -0.4665185278843038, -0.7404381133770168, -0.09081710503328452, 0.9717611879428086, 0.0, 0.0, 0.0, 0.0, -0.15150361419287176, -1.3777300045321985, -0.6882762365654653, 1.1808382500511247, 0.2947398967718114, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.7422804999805976, -1.6899175730753098, 0.20521305566233092, 0.1309470591384737, 1.6389823367575194, 0.0, 0.0, 0.0, 0.0, -0.22289002202115676, -0.07079897911318238, 0.4555888580331955, -0.9774805568535512, -0.07492800931526063, 0.0, 0.0, 0.0, 0.0, 0.2526615479800317, -0.1516626294547181, -1.0464629686670555, -0.5911144096314415, 0.9348812133375618, 0.0, 0.0, 0.0, 0.0, -0.27214147574211345, -0.3348828926273507, 2.397998460935664, 0.12247872552936973, 0.9434489339504347, 0.0, 0.0, 0.0, 0.0, -0.6209545562450115, 0.8905317474804172, 1.2224440041810367, 1.4018536953423328, -0.6227804114970024, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.3753419699769953, -0.4501284244570541, 0.1167711030619468, 0.244337560269405, 0.3227534725786205, 0.0, 0.0, 0.0, 0.0, -0.232650848389198, 0.5739554204930342, 0.25375005710835125, -0.23803764584562334, -1.993692474771535, 0.0, 0.0, 0.0, 0.0, -1.351782241279723, -1.6920626261921234, -1.2293336526286616, 0.9668537008565808, 0.0007723360430257239, 0.0, 0.0, 0.0, 0.0, -0.01230656738724467, 0.2675760840548762, 1.2762595664679257, 0.4102269624410474, -0.3722302434381652, 0.0, 0.0, 0.0, 0.0, 1.3372499867379761, -0.5879746009834493, -1.2257918141748945, -2.099874162209954, -0.20144638655894623, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 };
    tensor_t ref = tensor_make(shape_padded, dim_of_shape(shape_padded));
    tensor_fill_list(ref, ref_vals, array_size(ref_vals));

    tensor_t padded = tensor_make_padded_square_input_device(x, padding, pad_val);

    EXPECT_LT(tensor_rel_error(padded, ref), 1e-7);
  }

  TEST_F(LayerConvTestDevice, device_padding_2) {
    uint padding = 2;
    T pad_val = 0;

    uint shape_x [] = { 4, 3, 5, 5 };
    T x_vals[] = { -1.1124192987279753, -0.2987021326731024, -1.5717747799328543, 0.46767852410704136, -0.5028396636863578, 1.2617791569008552, -0.8585177727135882, -0.4600186852958477, -0.8077329473172338, 0.837235386721364, 0.7478347190253026, 0.5850240381114719, -0.6831412335120908, 0.058290015100482956, -0.20611346086035787, -0.0092610242642353, -0.44755780283533303, -0.253571347515263, 0.42442240380494484, 2.6112401994576913, 0.04861055692381238, -1.334453282928918, 0.7635961060571415, 1.5514060401392846, -1.3052188197958443, 1.3260095486113894, 0.8431812466250782, 1.3676397314745337, 0.4531808049657844, -0.26291312137449074, -0.7211846215031593, -0.41416476352211357, -0.7680383160486547, -1.5318621825008, -0.3578911332878774, 0.7759619266407034, -1.3431405218925165, -1.0063651740163926, -1.6542786299577552, -0.0546864101929225, 0.2110140307646673, -0.3768080385512793, -1.236797331853251, -0.1610635551341412, 1.0174638581542046, -1.7367701044281203, -1.2283226039281405, 1.544560063887768, -0.4577045674271423, -0.7267430108380676, -0.07147860413052132, 0.9483790393812896, 1.7129304374092102, 0.9467885337972222, -0.3541119869095083, 0.22755764922282137, 0.12163258604731675, 0.25732471941926455, 0.9886240504478493, 0.5601018574871774, -0.20450779339165723, -1.7077708511855116, -0.13013898639586138, 0.6079635545151538, 1.8886464208154448, -0.33226820215451974, -0.9686175941627132, 0.5649245499892915, -0.0044642904064593775, 0.03760473819194514, 0.7337002457763613, -1.7729387255390459, -0.046409256477280704, 0.6425112000074827, -0.4977857367683314, 0.7268829359507735, 1.0032165104227362, -0.6284984811880521, 0.17805656968486314, -0.014731135292292868, 0.9789927509821577, 0.09451447627885204, 0.17697028851028174, 1.0380679709985514, 1.0817780228586553, -0.8107008934371845, -0.6611898202651927, 0.4854310252420187, -0.21749810423696767, -0.7466953665614954, 0.17713389150383874, 0.19543354416360004, -0.04159744786730165, -0.3725044238710123, 0.7512088232874237, -0.771522407358809, 2.871219166464713, 0.2039736982769261, -0.17997388139156587, -0.6399549163641237, 0.7744330855318006, 2.25374450995983, -0.05617520123964064, 0.12081210772680644, 0.5345709706713304, -0.47548711865517834, -0.3066794980448487, -0.490663268698044, -1.0371380166676183, 0.7703229854920346, 0.3549900601179667, 1.6750252258682228, 2.1486748072483266, -0.9901275968971489, 0.608855344955566, -1.5302605972311867, 0.4656299607725897, -0.3551038820768038, -1.7065095073639251, -0.44279072724275603, -1.4717675757154216, 1.4748663019358406, 0.9354144556556001, 1.5333288764673847, -0.24395397881950812, 0.5796240826007605, -0.49618555357037075, 0.28379815216041704, -0.19429534593894787, -1.1281402889689527, 0.05140785554047687, 1.109003797791513, 0.10897572029369339, -0.7731322746786203, -0.07224906455636274, 1.5280643397671534, -0.5278848662905093, -0.47969299309344654, 1.718203478445837, 0.7373979390810084, 0.706670378804652, 0.39614034997439396, 0.49113458230443224, 1.6696855126170689, -1.2172522862953776, 0.20952491935114692, 0.04892714984661481, -1.9160747516922991, 0.7386962124836524, 0.14513097807367578, -0.41165110075172595, 0.4263195154168612, 1.059784992138269, 1.4396088218871332, 0.7875697623914744, 0.9197300938205939, -1.4838378616119423, 1.4025716495181753, -0.05742995650586157, -0.6628883583766395, -0.5540344135180969, -0.44655016139385023, -0.006333515734975038, -2.1399813677412287, -0.6623518265981271, 0.9939613809909453, -0.19740203989060595, 0.9321441807936072, 0.9608146403642486, -0.4351589019257472, 0.26220373811543335, -0.5710795497721404, 1.2082795439533207, -0.7496169866130366, -0.4360683763118623, -1.6415267042581436, 1.939907299240552, 0.9076772658657487, -0.00972516168486708, 0.10147601683170539, 0.06479463395816823, 0.8107139765683411, -0.5172929107224695, -1.0472327968440898, -1.3892994115182793, 0.8954615029175255, -0.8466045907148847, 0.6154824642536586, 0.7268584652936476, 1.838996443956697, -0.5847908764407355, -1.1011287947744466, 0.8010453177345396, 0.7501909639555887, 0.5501036795757065, 1.90942382787931, 0.30164664998042606, 0.8035841580641391, 1.0578983671386755, -0.5241724372612193, -0.9641123880248004, -0.22242605845205113, 0.13584339545444318, -1.6399978950667582, 1.1009293945087857, -0.4686778600191537, 0.962060577195541, -0.9899977318189975, 0.40140183035834603, -0.3808754358690001, -1.5376576761246183, -0.1113750451591103, -0.05433153669770133, 0.04270756686038058, 0.11016307773333747, 0.7088226143339001, 0.6623964615006589, -1.6437880492686265, 0.24972227567866892, -0.7190909576687361, 0.8709221416922429, 0.9736833351032012, -1.4354208104612605, -0.21452624995931732, -0.24002341761145385, -0.8792799209819383, -0.20515069357230428, -0.9031053506541381, 0.30535699100144026, -1.3242346085838523, -0.2829852663605533, 0.6683862897277222, 1.5413221726616706, 0.015682502128203546, 1.8958955433429994, -1.8359568427505848, -0.6421019796721616, -0.6269020512767177, 0.7983102935697899, 0.3213097538334444, -0.01729979144420373, -0.4665185278843038, -0.7404381133770168, -0.09081710503328452, 0.9717611879428086, -0.15150361419287176, -1.3777300045321985, -0.6882762365654653, 1.1808382500511247, 0.2947398967718114, -0.7422804999805976, -1.6899175730753098, 0.20521305566233092, 0.1309470591384737, 1.6389823367575194, -0.22289002202115676, -0.07079897911318238, 0.4555888580331955, -0.9774805568535512, -0.07492800931526063, 0.2526615479800317, -0.1516626294547181, -1.0464629686670555, -0.5911144096314415, 0.9348812133375618, -0.27214147574211345, -0.3348828926273507, 2.397998460935664, 0.12247872552936973, 0.9434489339504347, -0.6209545562450115, 0.8905317474804172, 1.2224440041810367, 1.4018536953423328, -0.6227804114970024, -1.3753419699769953, -0.4501284244570541, 0.1167711030619468, 0.244337560269405, 0.3227534725786205, -0.232650848389198, 0.5739554204930342, 0.25375005710835125, -0.23803764584562334, -1.993692474771535, -1.351782241279723, -1.6920626261921234, -1.2293336526286616, 0.9668537008565808, 0.0007723360430257239, -0.01230656738724467, 0.2675760840548762, 1.2762595664679257, 0.4102269624410474, -0.3722302434381652, 1.3372499867379761, -0.5879746009834493, -1.2257918141748945, -2.099874162209954, -0.20144638655894623 };
    tensor_t x = tensor_make(shape_x, dim_of_shape(shape_x));
    tensor_fill_list(x, x_vals, array_size(x_vals));

    uint shape_padded[] = { 4, 3, 9, 9 };
    T ref_vals[] = { 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.1124192987279753, -0.2987021326731024, -1.5717747799328543, 0.46767852410704136, -0.5028396636863578, 0.0, 0.0, 0.0, 0.0, 1.2617791569008552, -0.8585177727135882, -0.4600186852958477, -0.8077329473172338, 0.837235386721364, 0.0, 0.0, 0.0, 0.0, 0.7478347190253026, 0.5850240381114719, -0.6831412335120908, 0.058290015100482956, -0.20611346086035787, 0.0, 0.0, 0.0, 0.0, -0.0092610242642353, -0.44755780283533303, -0.253571347515263, 0.42442240380494484, 2.6112401994576913, 0.0, 0.0, 0.0, 0.0, 0.04861055692381238, -1.334453282928918, 0.7635961060571415, 1.5514060401392846, -1.3052188197958443, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.3260095486113894, 0.8431812466250782, 1.3676397314745337, 0.4531808049657844, -0.26291312137449074, 0.0, 0.0, 0.0, 0.0, -0.7211846215031593, -0.41416476352211357, -0.7680383160486547, -1.5318621825008, -0.3578911332878774, 0.0, 0.0, 0.0, 0.0, 0.7759619266407034, -1.3431405218925165, -1.0063651740163926, -1.6542786299577552, -0.0546864101929225, 0.0, 0.0, 0.0, 0.0, 0.2110140307646673, -0.3768080385512793, -1.236797331853251, -0.1610635551341412, 1.0174638581542046, 0.0, 0.0, 0.0, 0.0, -1.7367701044281203, -1.2283226039281405, 1.544560063887768, -0.4577045674271423, -0.7267430108380676, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.07147860413052132, 0.9483790393812896, 1.7129304374092102, 0.9467885337972222, -0.3541119869095083, 0.0, 0.0, 0.0, 0.0, 0.22755764922282137, 0.12163258604731675, 0.25732471941926455, 0.9886240504478493, 0.5601018574871774, 0.0, 0.0, 0.0, 0.0, -0.20450779339165723, -1.7077708511855116, -0.13013898639586138, 0.6079635545151538, 1.8886464208154448, 0.0, 0.0, 0.0, 0.0, -0.33226820215451974, -0.9686175941627132, 0.5649245499892915, -0.0044642904064593775, 0.03760473819194514, 0.0, 0.0, 0.0, 0.0, 0.7337002457763613, -1.7729387255390459, -0.046409256477280704, 0.6425112000074827, -0.4977857367683314, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7268829359507735, 1.0032165104227362, -0.6284984811880521, 0.17805656968486314, -0.014731135292292868, 0.0, 0.0, 0.0, 0.0, 0.9789927509821577, 0.09451447627885204, 0.17697028851028174, 1.0380679709985514, 1.0817780228586553, 0.0, 0.0, 0.0, 0.0, -0.8107008934371845, -0.6611898202651927, 0.4854310252420187, -0.21749810423696767, -0.7466953665614954, 0.0, 0.0, 0.0, 0.0, 0.17713389150383874, 0.19543354416360004, -0.04159744786730165, -0.3725044238710123, 0.7512088232874237, 0.0, 0.0, 0.0, 0.0, -0.771522407358809, 2.871219166464713, 0.2039736982769261, -0.17997388139156587, -0.6399549163641237, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7744330855318006, 2.25374450995983, -0.05617520123964064, 0.12081210772680644, 0.5345709706713304, 0.0, 0.0, 0.0, 0.0, -0.47548711865517834, -0.3066794980448487, -0.490663268698044, -1.0371380166676183, 0.7703229854920346, 0.0, 0.0, 0.0, 0.0, 0.3549900601179667, 1.6750252258682228, 2.1486748072483266, -0.9901275968971489, 0.608855344955566, 0.0, 0.0, 0.0, 0.0, -1.5302605972311867, 0.4656299607725897, -0.3551038820768038, -1.7065095073639251, -0.44279072724275603, 0.0, 0.0, 0.0, 0.0, -1.4717675757154216, 1.4748663019358406, 0.9354144556556001, 1.5333288764673847, -0.24395397881950812, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5796240826007605, -0.49618555357037075, 0.28379815216041704, -0.19429534593894787, -1.1281402889689527, 0.0, 0.0, 0.0, 0.0, 0.05140785554047687, 1.109003797791513, 0.10897572029369339, -0.7731322746786203, -0.07224906455636274, 0.0, 0.0, 0.0, 0.0, 1.5280643397671534, -0.5278848662905093, -0.47969299309344654, 1.718203478445837, 0.7373979390810084, 0.0, 0.0, 0.0, 0.0, 0.706670378804652, 0.39614034997439396, 0.49113458230443224, 1.6696855126170689, -1.2172522862953776, 0.0, 0.0, 0.0, 0.0, 0.20952491935114692, 0.04892714984661481, -1.9160747516922991, 0.7386962124836524, 0.14513097807367578, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.41165110075172595, 0.4263195154168612, 1.059784992138269, 1.4396088218871332, 0.7875697623914744, 0.0, 0.0, 0.0, 0.0, 0.9197300938205939, -1.4838378616119423, 1.4025716495181753, -0.05742995650586157, -0.6628883583766395, 0.0, 0.0, 0.0, 0.0, -0.5540344135180969, -0.44655016139385023, -0.006333515734975038, -2.1399813677412287, -0.6623518265981271, 0.0, 0.0, 0.0, 0.0, 0.9939613809909453, -0.19740203989060595, 0.9321441807936072, 0.9608146403642486, -0.4351589019257472, 0.0, 0.0, 0.0, 0.0, 0.26220373811543335, -0.5710795497721404, 1.2082795439533207, -0.7496169866130366, -0.4360683763118623, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.6415267042581436, 1.939907299240552, 0.9076772658657487, -0.00972516168486708, 0.10147601683170539, 0.0, 0.0, 0.0, 0.0, 0.06479463395816823, 0.8107139765683411, -0.5172929107224695, -1.0472327968440898, -1.3892994115182793, 0.0, 0.0, 0.0, 0.0, 0.8954615029175255, -0.8466045907148847, 0.6154824642536586, 0.7268584652936476, 1.838996443956697, 0.0, 0.0, 0.0, 0.0, -0.5847908764407355, -1.1011287947744466, 0.8010453177345396, 0.7501909639555887, 0.5501036795757065, 0.0, 0.0, 0.0, 0.0, 1.90942382787931, 0.30164664998042606, 0.8035841580641391, 1.0578983671386755, -0.5241724372612193, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.9641123880248004, -0.22242605845205113, 0.13584339545444318, -1.6399978950667582, 1.1009293945087857, 0.0, 0.0, 0.0, 0.0, -0.4686778600191537, 0.962060577195541, -0.9899977318189975, 0.40140183035834603, -0.3808754358690001, 0.0, 0.0, 0.0, 0.0, -1.5376576761246183, -0.1113750451591103, -0.05433153669770133, 0.04270756686038058, 0.11016307773333747, 0.0, 0.0, 0.0, 0.0, 0.7088226143339001, 0.6623964615006589, -1.6437880492686265, 0.24972227567866892, -0.7190909576687361, 0.0, 0.0, 0.0, 0.0, 0.8709221416922429, 0.9736833351032012, -1.4354208104612605, -0.21452624995931732, -0.24002341761145385, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.8792799209819383, -0.20515069357230428, -0.9031053506541381, 0.30535699100144026, -1.3242346085838523, 0.0, 0.0, 0.0, 0.0, -0.2829852663605533, 0.6683862897277222, 1.5413221726616706, 0.015682502128203546, 1.8958955433429994, 0.0, 0.0, 0.0, 0.0, -1.8359568427505848, -0.6421019796721616, -0.6269020512767177, 0.7983102935697899, 0.3213097538334444, 0.0, 0.0, 0.0, 0.0, -0.01729979144420373, -0.4665185278843038, -0.7404381133770168, -0.09081710503328452, 0.9717611879428086, 0.0, 0.0, 0.0, 0.0, -0.15150361419287176, -1.3777300045321985, -0.6882762365654653, 1.1808382500511247, 0.2947398967718114, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.7422804999805976, -1.6899175730753098, 0.20521305566233092, 0.1309470591384737, 1.6389823367575194, 0.0, 0.0, 0.0, 0.0, -0.22289002202115676, -0.07079897911318238, 0.4555888580331955, -0.9774805568535512, -0.07492800931526063, 0.0, 0.0, 0.0, 0.0, 0.2526615479800317, -0.1516626294547181, -1.0464629686670555, -0.5911144096314415, 0.9348812133375618, 0.0, 0.0, 0.0, 0.0, -0.27214147574211345, -0.3348828926273507, 2.397998460935664, 0.12247872552936973, 0.9434489339504347, 0.0, 0.0, 0.0, 0.0, -0.6209545562450115, 0.8905317474804172, 1.2224440041810367, 1.4018536953423328, -0.6227804114970024, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.3753419699769953, -0.4501284244570541, 0.1167711030619468, 0.244337560269405, 0.3227534725786205, 0.0, 0.0, 0.0, 0.0, -0.232650848389198, 0.5739554204930342, 0.25375005710835125, -0.23803764584562334, -1.993692474771535, 0.0, 0.0, 0.0, 0.0, -1.351782241279723, -1.6920626261921234, -1.2293336526286616, 0.9668537008565808, 0.0007723360430257239, 0.0, 0.0, 0.0, 0.0, -0.01230656738724467, 0.2675760840548762, 1.2762595664679257, 0.4102269624410474, -0.3722302434381652, 0.0, 0.0, 0.0, 0.0, 1.3372499867379761, -0.5879746009834493, -1.2257918141748945, -2.099874162209954, -0.20144638655894623, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 };
    tensor_t ref = tensor_make(shape_padded, dim_of_shape(shape_padded));
    tensor_fill_list(ref, ref_vals, array_size(ref_vals));

    tensor_t padded = tensor_make_padded_square_input_device(x, padding, pad_val);

    EXPECT_LT(tensor_rel_error(padded, ref), 1e-7);
  }

  /**
   * This first test uses a very simple (not padded) and very small
   * input.
   */
  TEST_F(LayerConvTestDevice, im2col_inner_device_1) {
    uint C = 2, H = 3, HH = 2, N = 1, W = 3, WW = 2, filter_height = 2, filter_width = 2, padding = 0, stride = 1;

    uint shape_cols[] = { 8, 4 };
    uint shape_x_padded[] = { 1, 2, 3, 3 };

    tensor_t cols = tensor_make_scalar(shape_cols, dim_of_shape(shape_cols), 0);

    T x_padded_vals[] = { 1, 0, 1, 0, 1, 0, 1, 1, 1, 2, 3, 2, 1, 0, 1, 2, 1, 2 };
    tensor_t x_padded = tensor_make(shape_x_padded, dim_of_shape(shape_x_padded));
    tensor_fill_list(x_padded, x_padded_vals, array_size(x_padded_vals));

    tensor_t cols_ref = tensor_make_alike(cols);
    T value_list[] = { 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 2, 3, 1, 0, 3, 2, 0, 1, 1, 0, 2, 1, 0, 1, 1, 2 };
    tensor_fill_list(cols_ref, value_list, array_size(value_list));

    im2col_inner_device(cols, x_padded, N, C, H, W, HH, WW, filter_height, filter_width, padding, stride);

    EXPECT_LT(tensor_rel_error(cols_ref, cols), 1e-7);
    PINF("Consistent with expected results");
  }
#endif


//  uint HH = int((H + 2 * conv_params.padding - filter_height) / conv_params.stride + 1)  # number of times filter will be applied in height dimension
//  uint WW = int((W + 2 * padding - filter_width) / stride + 1)   # number of times filter will be applied in width dimension
}

int main(int argc, char **argv) {
  ::testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
